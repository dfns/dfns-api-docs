# CompleteUserActionSigning

`POST /auth/action`

Completes the user action signing process and provides a signing token that can be used to verify the user intended to perform the action.

### Required Permissions <a href="#scopes" id="scopes"></a>

`N/A`

### Parameters <a href="#parameters.1" id="parameters.1"></a>

### Headers  <a href="#request-body" id="request-body"></a>

| Name | Required | Description |
| ---- | -------- | ----------- |
| X-DFNS-NONCE | Required | <p>Random value used to prevent replay attacks. Format is base64url encoded JSON string with the following fields: <br>uuid: &#x3C;random value> <br>datetime: &#x3C;The current time of the request in ISO String format, used to expire requests after a period of time></p> |
| X-DFNS-APPID | Required | ID of the application that was created in the Dfns dashboard |
| X-DFNS-APPSECRET | Optional | Secret associated with the application. Required for server-side application configurations. |
| X-DFNS-APISIGNATURE | Optional | Signature for the API request. Required for server-side application configurations. |
| Authorization | Required | `token` returned from the [Create User Login](../login/completeLogin.md) call, in Bearer format. |

### Request body <a href="#request-body" id="request-body"></a>

| Request body fields   | Required/Optional | Description | Type   |
| --------------------- | ----------------- | ----------- | ------ |
| `challengeIdentifier` | Required | The temporary authentication token returned by the [Create User Action Signature Challenge](./initUserActionSigning.md) call | String |
| `firstFactor` | Requires | The first factor credential used to authenticate a user | [AuthenticateUserFirstFactor](#authenticate-user-first-factor) |
| `secondFactor` | Optional | The second factor credential used to authenticate a user | [AuthenticateUserSecondFactor](#authenticate-user-second-factor) |

#### AuthenticateUserFirstFactor <a href="#authenticate-user-first-factor" id="authenticate-user-first-factor"></a>

| Fields | Required/Optional | Description | Type |
| ------ | ----------------- | ----------- | ---- |
| `kind` | Required | The kind of credential used by the user | String |
| `credentialAssertion` | Optional | A [KeyCredentialAssertion](#key-credential-assertion) object when `kind` is `Key` or a [Fido2CredentialAssertion](#fido2-credential-assertion) when `kind` is `Fido2`. Required when `kind` is `Fido2` or `Key` | String |
| `password` | Optional | The user's password. Required when `kind` is `Password` | String |

#### AuthenticateUserSecondFactor <a href="#authenticate-user-second-factor" id="authenticate-user-second-factor"></a>

| Fields | Required/Optional | Description | Type |
| ------ | ----------------- | ----------- | ---- |
| `kind` | Required | The kind of credential used by the user | String |
| `credentialAssertion` | Optional | A [KeyCredentialAssertion](#key-credential-assertion) object when `kind` is `Key` or a [Fido2CredentialAssertion](#fido2-credential-assertion) when `kind` is `Fido2`. Required when `kind` is `Fido2` or `Key` | String |
| `otpCode` | Optional | The 6 digit code generated by the user's Authenticator device. Required when `kind` is `Totp` | String |

#### KeyCredentialAssertion <a href="#key-credential-assertion" id="key-credential-assertion"></a>

| Fields | Required/Optional | Description | Type |
| ------ | ----------------- | ----------- | ---- |
| `credId` | Required | The base64url encoded id of the credential | String |
| `clientData` | Required | The base64url encoded [KeyClientData](#key-client-data) JSON string object that was signed with the user's private key | String |
| `signature` | Optional | The base64url encoded signature generated by signing the clientData JSON string object | String |

#### KeyClientData <a href="#key-client-data" id="key-client-data"></a>

| Fields | Required/Optional | Description | Type |
| ------ | ----------------- | ----------- | ---- |
| `type` | Required | A string identifying the kind of client data this object represents. For signing, this must be set to `key.get` | String  |
| `challenge` | Required | The challenge returned by the [Create User Action Challenge](./initUserActionSigning.md) call | String  |
| `origin` | Required | The origin in which the request was signed. This should match the origin you configured for your Dfns Application. For example, Dfns Dashboard signatures would set this to `https://dashboard.dfns.io` | String  |
| `crossOrigin` | Optional | A flag indicating if the request was signed for a cross-origin request | Boolean |

#### Fido2CredentialAssertion <a href="#fido2-credential-assertion" id="fido2-credential-assertion"></a>

| Fields | Required/Optional | Description | Type |
| ------ | ----------------- | ----------- | ---- |
| `credId` | Required | The base64url encoded id of the credential returned by the user's WebAuthn client | String |
| `clientData` | Required | The base64url encoded client data object returned by the user's WebAuthn client | String |
| `authenticatorData` | Optional | The base64url encoded authenticator data object returned by the user's WebAuthn client | String |
| `signature` | Optional | The base64url encoded signature returned by the user's WebAuthn client | String |
| `userHandle` | Optional | The base64url encoded userHandle returned by the user's WebAuthn client | String |


##### Typescript example using a browser's builtin WebAuthn client to request user authentication and generate the CompleteUserActionSigning RequestBody

```Typescript
const credential: PublicKeyCredential = await navigator.credentials.get({
  mediation: 'required',
  publicKey: {
    challenge: Buffer.from(authOptions.challenge),
    allowCredentials: authOptions.allowCredentials.webauthn.map((cred) => ({
      id: base64UrlStringToBuffer(cred.id),
      type: 'public-key',
      transports: cred.transports as AuthenticatorTransport[],
    })),
    rpId: this.options.server,
    userVerification: "required",
    timeout: 60000
  }
}) as PublicKeyCredential

const response = credential.response as AuthenticatorAssertionResponse
const completeUserActionSigningRequestBody = {
  challengeIdentifier: authOptions.challengeIdentifier,
  firstFactor: {
    kind: 'Fido2',
    credentialAssertion: {
      authenticatorData: arrayBufferToBase64UrlString(response.authenticatorData),
      clientData: arrayBufferToBase64UrlString(response.clientDataJSON),
      credId: credential.id,
      signature: arrayBufferToBase64UrlString(response.signature),
      userHandle: arrayBufferToBase64UrlString(response.userHandle),
    }
  }
}
```


### Request example <a href="#request-example.1" id="request-example.1"></a>

#### Sample request <a href="#sample-request" id="sample-request"></a>

```bash
currentTime=$( date -u +"%Y-%m-%dT%H:%M:%SZ" )
nonce=$( echo "{\"datetime\":\"$currentTime\",\"nonce\":\"$(uuidgen)\"}" | base64 | tr '/+' '_-' | tr -d '=' )
curl -X POST "/auth/action" \
-H "Content-Type: application/json" \
-H "X-DFNS-NONCE: $nonce" \
-H "X-DFNS-APPID: 312CE25E-A112-4D45-9965-6175E7C568DD" \
-H "Authorization: Bearer <UserAuthToken>" \
-d '{
  "challengeIdentifier": "eyJ0eXAiOiJKV1Q...X1bwCg35kbzsjA",
  "firstFactor": {
    "kind": "Fido2",
    "credentialAssertion": {
      "credId": "dV9U2F...DO3dTlr",
      "clientData": "eyJ0eXBlIjoid2ViY...OfeSY",
      "signature": "ZTVmM2...WVlMmE0"
    }
  }
}'
```

### Response <a href="#response" id="response"></a>

* `userAction` is a token that will be passed in the X-DFNS-USERACTION header when performing a change request. The Dfns API will be able to use the information in the token to verify the user initiated the action

#### Response example <a href="#response-example" id="response-example"></a>

```json
{
    "userAction": "eyJ0eX...bzrQakA"
}
```

### Notes <a href="#notes" id="notes"></a>

